#!/usr/bin/env python3

"""
Created on 1 Jan 2026

@author: Bruno Beloff (bbeloff@me.com)

source repo: mrcs_control

DESCRIPTION
A service to record cron event schedules according to model time
Note that in --subscribe mode, the utility runs forever.

Test with:
cli/mrcs_publisher -vti4 -t CRN -m '{"event_id": "abc", "on": "2026-01-03T06:00:00.000"}'

SYNOPSIS
mrcs_crontab [-h] [-i INDENT] [-v] [--version] [-t] (-c | -r | -s)

EXAMPLES
mrcs_crontab --verbose --subscribe --test

SEE ALSO
mrcs_cron
"""

import sys

from mrcs_control.cli.args.crontab_args import CrontabArgs
from mrcs_control.operations.time.crontab import Crontab

from mrcs_core.data.json import JSONify
from mrcs_core.sys.logging import Logging


# TODO: find out why it does not get the first message on startup - needs second message?
# --------------------------------------------------------------------------------------------------------------------

if __name__ == '__main__':

    # ----------------------------------------------------------------------------------------------------------------

    args = CrontabArgs('a service to record cron event schedules according to model time')

    Logging.config('mrcs_crontab', verbose=args.verbose)
    logger = Logging.getLogger()
    logger.info(f'args: {args}')
    logger.info(f'mode: {args.mode.value}')


    # ----------------------------------------------------------------------------------------------------------------

    try:
        crontab = Crontab.construct(args.mode)
        logger.info(f'crontab: {crontab}')

        if args.clean:
            crontab.clean()
            exit(0)

        if args.report:
            records = list(crontab.find_all())
            print(JSONify.dumps(records, indent=args.indent))

            logger.info(f'found {len(records)} items.')
            exit(0)

        if args.subscribe:
            crontab.subscribe()
            exit(0)


    # ----------------------------------------------------------------------------------------------------------------

    except KeyboardInterrupt:
        print(file=sys.stderr)
